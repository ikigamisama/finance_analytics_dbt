version: 2

models:
  # ===================================================================
  # SILVER LAYER TESTS
  # ===================================================================

  - name: stg_customers
    description: "Cleaned customer master data"
    tests:
      - dbt_utils.recency:
          datepart: day
          field: updated_at
          interval: 1
    columns:
      - name: customer_id
        description: "Unique customer identifier"
        tests:
          - unique
          - not_null
      - name: email
        description: "Customer email address"
        tests:
          - unique
          - not_null
      - name: credit_score
        description: "Customer credit score"
        tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 300
              max_value: 850
      - name: age
        description: "Customer age"
        tests:
          - dbt_utils.accepted_range:
              min_value: 18
              max_value: 120
      - name: annual_income
        description: "Annual income"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 10000000
      - name: churn_risk_score
        description: "Churn probability score"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              inclusive: true

  - name: stg_transactions
    description: "Cleaned transaction data"
    tests:
      - dbt_utils.recency:
          datepart: hour
          field: transaction_date
          interval: 24
    columns:
      - name: transaction_id
        description: "Unique transaction identifier"
        tests:
          - unique
          - not_null
      - name: account_id
        description: "Account identifier"
        tests:
          - not_null
          - relationships:
              to: ref('stg_accounts')
              field: account_id
      - name: customer_id
        description: "Customer identifier"
        tests:
          - not_null
          - relationships:
              to: ref('stg_customers')
              field: customer_id
      - name: amount
        description: "Transaction amount"
        tests:
          - not_null
      - name: fraud_score
        description: "Fraud probability score"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              inclusive: true
      - name: transaction_status
        description: "Transaction status"
        tests:
          - accepted_values:
              values: ["Approved", "Declined", "Fraud"]

  - name: stg_accounts
    description: "Cleaned account data"
    columns:
      - name: account_id
        description: "Unique account identifier"
        tests:
          - unique
          - not_null
      - name: customer_id
        description: "Customer identifier"
        tests:
          - not_null
          - relationships:
              to: ref('stg_customers')
              field: customer_id
      - name: product_id
        description: "Product identifier"
        tests:
          - not_null
      - name: account_status
        description: "Account status"
        tests:
          - accepted_values:
              values: ["Active", "Dormant", "Closed"]
      - name: credit_utilization_pct
        description: "Credit utilization percentage"
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 200 # Can exceed 100% if over limit
              inclusive: true
              where: "credit_limit IS NOT NULL AND credit_limit > 0"

  - name: stg_credit_applications
    description: "Credit application staging data"
    columns:
      - name: application_id
        tests:
          - unique
          - not_null
      - name: decision
        tests:
          - accepted_values:
              values: ["Approved", "Declined", "Pending"]
      - name: debt_to_income_ratio
        tests:
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 2
              inclusive: true

  - name: stg_fraud_alerts
    description: "Fraud alert staging data"
    columns:
      - name: alert_id
        tests:
          - unique
          - not_null
      - name: alert_severity
        tests:
          - accepted_values:
              values: ["Low", "Medium", "High", "Critical"]
      - name: investigation_status
        tests:
          - accepted_values:
              values:
                [
                  "Open",
                  "Under Review",
                  "Resolved - Fraud",
                  "Resolved - Legitimate",
                  "False Positive",
                ]

  - name: stg_products
    description: >
      Silver-layer staging table for financial products.
      This model cleans raw product data and enriches it with
      product hierarchy, pricing bands, risk levels, and
      customer targeting attributes.
    tags: ["silver", "ingestion", "products"]
    columns:
      - name: product_id
        description: Primary key for the product.
        tests:
          - not_null
          - unique

      - name: product_name
        description: Cleaned product name.
        tests:
          - not_null

      - name: category
        description: Normalized product category in uppercase.

      - name: product_line
        description: High-level product line derived from category
          (e.g., Banking, Lending, Wealth Management).

      - name: interest_rate
        description: Base interest rate expressed as a decimal value.

      - name: interest_rate_pct
        description: Interest rate converted to percentage format.

      - name: min_balance
        description: Minimum required balance for the product.

      - name: monthly_fee
        description: Monthly maintenance fee charged to the customer.

      - name: overdraft_limit
        description: Allowed overdraft limit for applicable products.

      - name: product_tier
        description: Product tier classification
          (e.g., Basic, Standard, Premium, Business).

      - name: is_premium
        description: Boolean flag indicating whether the product is premium.

      - name: product_type_desc
        description: Human-readable description of product type
          (Premium vs Standard).

      - name: fee_category
        description: Fee-based segmentation derived from monthly fee.

      - name: rate_category
        description: Interest rate band classification.

      - name: complexity_score
        description: Numeric score (0â€“100) representing product complexity.

      - name: target_segment
        description: Intended customer segment(s) for the product.

      - name: risk_level
        description: Risk classification associated with the product.

      - name: revenue_model
        description: Primary revenue model associated with the product.

      - name: updated_at
        description: Timestamp indicating when the record was last updated.

  - name: stg_merchants
    description: >
      Silver-layer staging table for merchants.
      This model standardizes merchant attributes, enriches
      geographic, risk, and transaction characteristics, and
      derives business maturity indicators.
    tags: ["silver", "ingestion", "merchants"]
    columns:
      - name: merchant_id
        description: Primary key for the merchant.
        tests:
          - not_null
          - unique

      - name: merchant_name
        description: Cleaned merchant name.
        tests:
          - not_null

      - name: category
        description: Normalized merchant category in uppercase.

      - name: mcc_code
        description: Merchant Category Code (MCC).

      - name: category_group
        description: High-level merchant category grouping.

      - name: city
        description: Merchant city in uppercase.

      - name: state
        description: Merchant state or province in uppercase.

      - name: country
        description: Merchant country in uppercase.

      - name: latitude
        description: Geographic latitude of the merchant location.

      - name: longitude
        description: Geographic longitude of the merchant location.

      - name: region
        description: Derived geographic region based on state.

      - name: risk_rating
        description: Qualitative merchant risk rating
          (Low, Medium, High).

      - name: risk_score
        description: Numeric risk score derived from risk rating.

      - name: avg_transaction_amount
        description: Average transaction amount for the merchant.

      - name: transaction_value_segment
        description: Transaction value band derived from average transaction amount.

      - name: is_online
        description: Boolean flag indicating whether the merchant operates online.

      - name: merchant_type
        description: Merchant channel classification
          (Online vs Physical).

      - name: established_date
        description: Date when the merchant business was established.

      - name: years_in_business
        description: Number of years the merchant has been in business.

      - name: business_maturity
        description: Business maturity classification
          (New, Growing, Established, Mature).

      - name: mcc_category
        description: Major MCC category derived from MCC code ranges.

      - name: updated_at
        description: Timestamp indicating when the record was last updated.

  - name: stg_branch_locations
    description: "Cleaned and standardized branch location data from raw source"
    columns:
      - name: branch_id
        description: "Primary key - Unique branch identifier"
        tests:
          - unique
          - not_null

      - name: branch_code
        description: "Internal branch code (e.g., BR00123)"
        tests:
          - unique
          - not_null

      - name: branch_name
        description: "Branch name (cleaned and trimmed)"
        tests:
          - not_null

      - name: branch_type
        description: "Type of branch facility"
        tests:
          - accepted_values:
              values:
                [
                  "Full Service",
                  "Limited Service",
                  "Drive-Through Only",
                  "Commercial",
                ]

      - name: region
        description: "Geographic region"
        tests:
          - accepted_values:
              values: ["Northeast", "Southeast", "Midwest", "Southwest", "West"]

      - name: address
        description: "Street address (cleaned)"

      - name: city
        description: "City (cleaned)"
        tests:
          - not_null

      - name: state
        description: "State code - standardized to uppercase"
        tests:
          - not_null

      - name: zip_code
        description: "ZIP/Postal code (cleaned)"

      - name: country
        description: "Country code - standardized to uppercase"

      - name: latitude
        description: "Geographic latitude coordinate"

      - name: longitude
        description: "Geographic longitude coordinate"

      - name: phone
        description: "Branch phone number (cleaned)"

      - name: open_date
        description: "Branch opening date"
        tests:
          - not_null

      - name: is_active
        description: "Active branch flag"
        tests:
          - not_null

      - name: operating_hours
        description: "Branch operating hours"

      - name: square_footage
        description: "Branch size in square feet"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: num_employees
        description: "Number of employees at branch"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: avg_daily_customers
        description: "Average daily customer traffic"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: has_safe_deposit
        description: "Safe deposit box service available"

      - name: has_notary
        description: "Notary services available"

      - name: has_coin_counter
        description: "Coin counting machine available"

      - name: wheelchair_accessible
        description: "ADA accessibility flag"

      - name: manager_name
        description: "Branch manager name (cleaned)"

      - name: created_at
        description: "Record creation timestamp"

      - name: dbt_updated_at
        description: "dbt transformation timestamp"
        tests:
          - not_null

  - name: stg_atm_locations
    description: "Cleaned and standardized ATM location data from raw source"
    columns:
      - name: atm_id
        description: "Primary key - Unique ATM identifier"
        tests:
          - unique
          - not_null

      - name: atm_code
        description: "ATM code (e.g., ATM123456)"
        tests:
          - unique
          - not_null

      - name: location_name
        description: "Location descriptor (cleaned)"

      - name: location_type
        description: "ATM location type"
        tests:
          - accepted_values:
              values: ["Branch", "Off-Site", "Third-Party"]

      - name: address
        description: "Street address (cleaned)"

      - name: city
        description: "City (cleaned)"
        tests:
          - not_null

      - name: state
        description: "State code - standardized to uppercase"
        tests:
          - not_null

      - name: zip_code
        description: "ZIP/Postal code (cleaned)"

      - name: country
        description: "Country code - standardized to uppercase"

      - name: latitude
        description: "Geographic latitude coordinate"

      - name: longitude
        description: "Geographic longitude coordinate"

      - name: install_date
        description: "ATM installation date"
        tests:
          - not_null

      - name: is_operational
        description: "Operational status flag"
        tests:
          - not_null

      - name: is_24_hour
        description: "24-hour access flag"

      - name: is_deposit_enabled
        description: "Deposit functionality enabled"

      - name: is_cash_only
        description: "Cash-only ATM (no deposits)"

      - name: max_withdrawal_amount
        description: "Maximum single withdrawal amount"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: daily_transaction_limit
        description: "Maximum transactions per day per card"
        tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: avg_daily_transactions
        description: "Average daily transaction volume"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: cash_capacity
        description: "Maximum cash capacity (USD)"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: last_refill_date
        description: "Last cash refill date"

      - name: last_maintenance_date
        description: "Last maintenance/service date"

      - name: surcharge_fee
        description: "Surcharge fee for non-customer transactions"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: has_camera
        description: "Security camera present"

      - name: branch_id
        description: "Foreign key to branch_locations (null if off-site)"
        tests:
          - relationships:
              to: ref('stg_branch_locations')
              field: branch_id
              where: "branch_id IS NOT NULL"

      - name: created_at
        description: "Record creation timestamp"

      - name: dbt_updated_at
        description: "dbt transformation timestamp"
        tests:
          - not_null

  - name: stg_risk_assessments
    description: "Cleaned and standardized customer risk assessment data from raw source"
    columns:
      - name: assessment_id
        description: "Primary key - Unique assessment identifier"
        tests:
          - unique
          - not_null

      - name: customer_id
        description: "Foreign key to customers"
        tests:
          - not_null
          - relationships:
              to: ref('stg_customers')
              field: customer_id

      - name: assessment_date
        description: "Date of risk assessment"
        tests:
          - not_null

      - name: assessment_type
        description: "Type of assessment"
        tests:
          - accepted_values:
              values:
                - "Periodic Review"
                - "Account Opening"
                - "Transaction Triggered"
                - "Annual Review"
                - "High Risk Review"

      - name: next_review_date
        description: "Scheduled next review date"
        tests:
          - not_null

      - name: risk_rating
        description: "Overall risk rating"
        tests:
          - not_null
          - accepted_values:
              values: ["Low", "Medium", "High"]

      - name: risk_score
        description: "Quantitative risk score (0-1)"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 0 AND 1"

      - name: credit_risk
        description: "Credit risk component"
        tests:
          - accepted_values:
              values: ["Low", "Medium", "High"]

      - name: fraud_risk
        description: "Fraud risk component"
        tests:
          - accepted_values:
              values: ["Low", "Medium", "High"]

      - name: aml_risk
        description: "Anti-Money Laundering (AML) risk level"
        tests:
          - accepted_values:
              values: ["Low", "Medium", "High", "Critical"]

      - name: kyc_status
        description: "Know Your Customer (KYC) verification status"
        tests:
          - accepted_values:
              values: ["Verified", "Pending", "Expired", "Failed"]

      - name: kyc_last_updated
        description: "Last KYC update date"

      - name: pep_flag
        description: "Politically Exposed Person (PEP) flag"
        tests:
          - not_null

      - name: sanctions_flag
        description: "Sanctions list match flag"
        tests:
          - not_null

      - name: adverse_media_flag
        description: "Adverse media screening flag"
        tests:
          - not_null

      - name: high_value_customer
        description: "High value customer designation"

      - name: requires_enhanced_due_diligence
        description: "Enhanced due diligence (EDD) required flag"
        tests:
          - not_null

      - name: transaction_volume_last_90d
        description: "Transaction volume in last 90 days (USD)"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: num_accounts
        description: "Number of accounts held"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: years_as_customer
        description: "Customer tenure in years"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: employment_verified
        description: "Employment verification status"

      - name: income_verified
        description: "Income verification status"

      - name: address_verified
        description: "Address verification status"

      - name: regulatory_concerns
        description: "Specific regulatory concerns (cleaned)"

      - name: assessor_id
        description: "ID of compliance officer who performed assessment (cleaned)"

      - name: assessment_notes
        description: "Assessment notes and comments (cleaned)"

      - name: created_at
        description: "Record creation timestamp"

      - name: dbt_updated_at
        description: "dbt transformation timestamp"
        tests:
          - not_null

  - name: stg_account_events
    description: "Cleaned and standardized account lifecycle events from raw source"
    columns:
      - name: event_id
        description: "Primary key - Unique event identifier"
        tests:
          - unique
          - not_null

      - name: account_id
        description: "Foreign key to accounts"
        tests:
          - not_null
          - relationships:
              to: ref('stg_accounts')
              field: account_id

      - name: customer_id
        description: "Foreign key to customers"
        tests:
          - not_null
          - relationships:
              to: ref('stg_customers')
              field: customer_id

      - name: product_id
        description: "Foreign key to products"
        tests:
          - relationships:
              to: source('ingestion_raw_data', 'products')
              field: product_id
              where: "product_id IS NOT NULL"

      - name: event_date
        description: "Date and time of event"
        tests:
          - not_null

      - name: event_type
        description: "Type of account event (cleaned)"
        tests:
          - not_null

      - name: event_category
        description: "Event category grouping"
        tests:
          - accepted_values:
              values:
                - "Account Setup"
                - "Account Closure"
                - "Terms Change"
                - "Product Change"
                - "Fee Related"
                - "Payment Issue"
                - "Activity Status"
                - "Account Modification"

      - name: old_value
        description: "Previous value (for change events)"

      - name: new_value
        description: "New value (for change events)"

      - name: triggered_by
        description: "What triggered the event"
        tests:
          - accepted_values:
              values:
                - "Customer Request"
                - "System Automated"
                - "Bank Policy"
                - "Regulatory Requirement"
                - "Risk Management"
                - "Promotional Offer"

      - name: channel
        description: "Channel through which event was initiated"
        tests:
          - accepted_values:
              values: ["Online", "Mobile", "Branch", "Phone", "Mail", "System"]

      - name: processed_by
        description: "Employee ID who processed the event (cleaned)"

      - name: notes
        description: "Event notes and details (cleaned)"

      - name: is_reversible
        description: "Flag indicating if event can be reversed"

      - name: requires_approval
        description: "Flag indicating if event requires approval"

      - name: approval_status
        description: "Approval status (if applicable)"
        tests:
          - accepted_values:
              values: ["Approved", "Pending", "Rejected"]
              where: "approval_status IS NOT NULL"

      - name: created_at
        description: "Record creation timestamp"

      - name: dbt_updated_at
        description: "dbt transformation timestamp"
        tests:
          - not_null

  - name: stg_regulatory_reports
    description: "Cleaned and standardized regulatory compliance reports from raw source"
    columns:
      - name: report_id
        description: "Primary key - Unique report identifier"
        tests:
          - unique
          - not_null

      - name: report_type_code
        description: "Report type code - standardized to uppercase"
        tests:
          - not_null
          - accepted_values:
              values:
                [
                  "SAR",
                  "CTR",
                  "CIP",
                  "OFAC",
                  "BSA",
                  "HMDA",
                  "CRA",
                  "FFIEC",
                  "FDIC",
                  "FR-Y9C",
                  "AML",
                  "KYC",
                ]

      - name: report_type_name
        description: "Full report type name (cleaned)"
        tests:
          - not_null

      - name: report_frequency
        description: "Required reporting frequency"
        tests:
          - accepted_values:
              values: ["Daily", "Monthly", "Quarterly", "Annual", "As Needed"]

      - name: regulator
        description: "Regulatory body requiring the report (cleaned)"
        tests:
          - not_null

      - name: report_period_start
        description: "Reporting period start date"
        tests:
          - not_null

      - name: report_period_end
        description: "Reporting period end date"
        tests:
          - not_null

      - name: filing_date
        description: "Date report was generated"
        tests:
          - not_null

      - name: due_date
        description: "Regulatory due date"
        tests:
          - not_null

      - name: actual_filing_date
        description: "Actual date filed (null if not yet filed)"

      - name: filing_status
        description: "Current filing status"
        tests:
          - not_null
          - accepted_values:
              values:
                [
                  "Filed",
                  "Pending",
                  "In Review",
                  "Late Filed",
                  "Amended",
                  "Withdrawn",
                ]

      - name: filing_method
        description: "Method of filing"
        tests:
          - accepted_values:
              values: ["Electronic", "Paper"]

      - name: confirmation_number
        description: "Regulatory confirmation number (cleaned)"

      - name: customer_id
        description: "Related customer (if applicable)"
        tests:
          - relationships:
              to: ref('stg_customers')
              field: customer_id
              where: "customer_id IS NOT NULL"

      - name: account_id
        description: "Related account (if applicable)"
        tests:
          - relationships:
              to: ref('stg_accounts')
              field: account_id
              where: "account_id IS NOT NULL"

      - name: transaction_id
        description: "Related transaction (if applicable)"
        tests:
          - relationships:
              to: ref('stg_transactions')
              field: transaction_id
              where: "transaction_id IS NOT NULL"

      - name: amount_reported
        description: "Amount reported (if applicable)"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              where: "amount_reported IS NOT NULL"

      - name: risk_level
        description: "Risk level of the report"
        tests:
          - accepted_values:
              values: ["Low", "Medium", "High", "Critical"]

      - name: findings
        description: "Report findings summary (cleaned)"

      - name: requires_follow_up
        description: "Flag indicating follow-up required"

      - name: follow_up_date
        description: "Scheduled follow-up date"

      - name: assigned_to
        description: "Compliance officer assigned (cleaned)"

      - name: reviewed_by
        description: "Reviewer employee ID (cleaned)"

      - name: approval_date
        description: "Approval date"

      - name: is_amended
        description: "Flag indicating amended report"

      - name: original_report_id
        description: "Original report ID (for amendments)"
        tests:
          - relationships:
              to: ref('stg_regulatory_reports')
              field: report_id
              where: "original_report_id IS NOT NULL"

      - name: penalty_amount
        description: "Penalty amount (if late filed)"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
              where: "penalty_amount IS NOT NULL"

      - name: internal_notes
        description: "Internal compliance notes (cleaned)"

      - name: created_at
        description: "Record creation timestamp"

      - name: dbt_updated_at
        description: "dbt transformation timestamp"
        tests:
          - not_null

  - name: stg_customer_segments_history
    description: "Cleaned and standardized customer segment history (SCD Type 2) from raw source"
    columns:
      - name: segment_history_id
        description: "Primary key - Unique segment history record"
        tests:
          - unique
          - not_null

      - name: customer_id
        description: "Foreign key to customers"
        tests:
          - not_null
          - relationships:
              to: ref('stg_customers')
              field: customer_id

      - name: effective_date
        description: "Date segment became effective"
        tests:
          - not_null

      - name: end_date
        description: "Date segment ended (null for current segment)"

      - name: is_current
        description: "Flag indicating current active segment"
        tests:
          - not_null

      - name: customer_segment
        description: "Customer segment classification"
        tests:
          - not_null
          - accepted_values:
              values: ["Mass Market", "Affluent", "Premium", "Business"]

      - name: previous_segment
        description: "Previous customer segment"
        tests:
          - accepted_values:
              values: ["Mass Market", "Affluent", "Premium", "Business"]
              where: "previous_segment IS NOT NULL"

      - name: loyalty_tier
        description: "Loyalty program tier"
        tests:
          - not_null
          - accepted_values:
              values: ["Bronze", "Silver", "Gold", "Platinum"]

      - name: previous_tier
        description: "Previous loyalty tier"
        tests:
          - accepted_values:
              values: ["Bronze", "Silver", "Gold", "Platinum"]
              where: "previous_tier IS NOT NULL"

      - name: risk_segment
        description: "Risk classification"
        tests:
          - not_null
          - accepted_values:
              values: ["Low", "Medium", "High"]

      - name: previous_risk
        description: "Previous risk classification"
        tests:
          - accepted_values:
              values: ["Low", "Medium", "High"]
              where: "previous_risk IS NOT NULL"

      - name: change_type
        description: "Type of change that occurred"
        tests:
          - accepted_values:
              values:
                [
                  "Segment Change",
                  "Tier Change",
                  "Risk Change",
                  "Multiple Changes",
                ]

      - name: change_reason
        description: "Reason for segment change (cleaned)"

      - name: triggered_by
        description: "What triggered the segment change"
        tests:
          - accepted_values:
              values:
                - "Automated Rule"
                - "Manual Review"
                - "Relationship Manager"
                - "Risk Assessment"
                - "Behavioral Model"
                - "Campaign Response"

      - name: total_accounts
        description: "Number of accounts at time of change"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: total_balance
        description: "Total balance at time of change"

      - name: avg_monthly_transactions
        description: "Average monthly transaction count"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: products_held
        description: "Number of products held"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: customer_lifetime_value
        description: "Estimated CLV at time of change"

      - name: tenure_days
        description: "Customer tenure in days"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: credit_score
        description: "Credit score at time of change"
        tests:
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 300 AND 850"
              where: "credit_score IS NOT NULL"

      - name: annual_income
        description: "Annual income at time of change"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: last_interaction_days
        description: "Days since last interaction"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: digital_engagement_score
        description: "Digital engagement score (0-1)"
        tests:
          - dbt_utils.expression_is_true:
              expression: "BETWEEN 0 AND 1"

      - name: branch_visits_last_90d
        description: "Branch visits in last 90 days"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: online_logins_last_90d
        description: "Online logins in last 90 days"
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"

      - name: eligible_for_premium
        description: "Eligible for premium services"

      - name: churn_risk
        description: "Churn risk level"
        tests:
          - accepted_values:
              values: ["Low", "Medium", "High"]

      - name: cross_sell_opportunity
        description: "Cross-sell opportunity flag"

      - name: notes
        description: "Segment change notes (cleaned)"

      - name: updated_by
        description: "System or user who updated the segment (cleaned)"

      - name: created_at
        description: "Record creation timestamp"

      - name: dbt_updated_at
        description: "dbt transformation timestamp"
        tests:
          - not_null

  # ===================================================================
  # GOLD LAYER TESTS - DIMENSIONS
  # ===================================================================

  # - name: dim_customer
  #   description: "Customer dimension with SCD Type 2"
  #   tests:
  #     - dbt_utils.unique_combination_of_columns:
  #         combination_of_columns:
  #           - customer_id
  #           - effective_date
  #   columns:
  #     - name: customer_key
  #       description: "Surrogate key"
  #       tests:
  #         - unique
  #         - not_null
  #     - name: customer_id
  #       description: "Natural key"
  #       tests:
  #         - not_null
  #     - name: is_current
  #       description: "Current record flag"
  #       tests:
  #         - not_null
  #     - name: effective_date
  #       tests:
  #         - not_null
  #     - name: end_date
  #       tests:
  #         - not_null

  # - name: dim_date
  #   description: "Date dimension"
  #   tests:
  #     - dbt_utils.expression_is_true:
  #         expression: "date_key = TO_CHAR(date_actual, 'YYYYMMDD')::INTEGER"
  #   columns:
  #     - name: date_key
  #       description: "Date key in YYYYMMDD format"
  #       tests:
  #         - unique
  #         - not_null
  #     - name: date_actual
  #       tests:
  #         - unique
  #         - not_null
  #     - name: year
  #       tests:
  #         - dbt_utils.accepted_range:
  #             min_value: 2020
  #             max_value: 2030

  # - name: dim_merchant
  #   description: "Merchant dimension containing standardized merchant, geographic, and risk attributes."
  #   tags: ["gold", "dimension"]

  #   columns:
  #     - name: merchant_key
  #       description: Surrogate key for the merchant dimension.
  #       tests:
  #         - not_null
  #         - unique

  #     - name: merchant_id
  #       description: Natural business key from source systems.
  #       tests:
  #         - not_null
  #         - unique

  #     - name: merchant_name
  #       description: Name of the merchant.

  #     - name: category
  #       description: Merchant category.

  #     - name: category_group
  #       description: High-level merchant category grouping.

  #     - name: mcc_code
  #       description: Merchant Category Code.

  #     - name: mcc_category
  #       description: Major MCC category derived from MCC ranges.

  #     - name: city
  #       description: Merchant city.

  #     - name: state
  #       description: Merchant state or region.

  #     - name: country
  #       description: Merchant country.

  #     - name: region
  #       description: Derived geographic region.

  #     - name: latitude
  #       description: Merchant latitude coordinate.

  #     - name: longitude
  #       description: Merchant longitude coordinate.

  #     - name: risk_rating
  #       description: Merchant risk rating.
  #       tests:
  #         - accepted_values:
  #             values: ["Low", "Medium", "High"]

  #     - name: risk_score
  #       description: Numeric risk score derived from risk rating.

  #     - name: avg_transaction_amount
  #       description: Average transaction amount.

  #     - name: transaction_value_segment
  #       description: Transaction value segmentation.

  #     - name: is_online
  #       description: Indicates whether the merchant operates online.

  #     - name: merchant_type
  #       description: Merchant type (Online vs Physical).

  #     - name: established_date
  #       description: Date the merchant was established.

  #     - name: years_in_business
  #       description: Number of years the merchant has been operating.

  #     - name: business_maturity
  #       description: Business maturity classification.

  #     - name: dw_created_at
  #       description: Timestamp when the record was created in the data warehouse.

  #     - name: dw_updated_at
  #       description: Timestamp when the record was last updated in the data warehouse.

  # - name: dim_merchant
  #   description: "Merchant dimension"
  #   columns:
  #     - name: merchant_key
  #       tests:
  #         - unique
  #         - not_null
  #     - name: merchant_id
  #       tests:
  #         - unique
  #         - not_null
  #     - name: risk_rating
  #       tests:
  #         - accepted_values:
  #             values: ["Low", "Medium", "High"]

  # # ===================================================================
  # # GOLD LAYER TESTS - FACTS
  # # ===================================================================

  # - name: fact_transactions
  #   description: "Transaction fact table"
  #   tests:
  #     - dbt_utils.recency:
  #         datepart: day
  #         field: transaction_date
  #         interval: 2
  #   columns:
  #     - name: transaction_id
  #       description: "Primary key"
  #       tests:
  #         - unique
  #         - not_null
  #     - name: customer_key
  #       description: "Foreign key to dim_customer"
  #       tests:
  #         - not_null
  #         - relationships:
  #             to: ref('dim_customer')
  #             field: customer_key
  #     - name: product_key
  #       description: "Foreign key to dim_product"
  #       tests:
  #         - relationships:
  #             to: ref('dim_product')
  #             field: product_key
  #     - name: merchant_key
  #       description: "Foreign key to dim_merchant"
  #       tests:
  #         - relationships:
  #             to: ref('dim_merchant')
  #             field: merchant_key
  #     - name: date_key
  #       description: "Foreign key to dim_date"
  #       tests:
  #         - not_null
  #         - relationships:
  #             to: ref('dim_date')
  #             field: date_key
  #     - name: transaction_amount
  #       tests:
  #         - not_null
  #     - name: transaction_count
  #       tests:
  #         - not_null
  #         - accepted_values:
  #             values: [1]

  # - name: fact_account_daily_snapshot
  #   description: "Daily account balance snapshots"
  #   tests:
  #     - dbt_utils.unique_combination_of_columns:
  #         combination_of_columns:
  #           - account_id
  #           - snapshot_date
  #   columns:
  #     - name: account_id
  #       tests:
  #         - not_null
  #     - name: snapshot_date
  #       tests:
  #         - not_null
  #     - name: customer_key
  #       tests:
  #         - not_null
  #         - relationships:
  #             to: ref('dim_customer')
  #             field: customer_key
  #     - name: date_key
  #       tests:
  #         - not_null
  #         - relationships:
  #             to: ref('dim_date')
  #             field: date_key

  # - name: fact_customer_monthly
  #   description: "Monthly customer aggregates"
  #   tests:
  #     - dbt_utils.unique_combination_of_columns:
  #         combination_of_columns:
  #           - customer_key
  #           - month_key
  #   columns:
  #     - name: customer_key
  #       tests:
  #         - not_null
  #     - name: month_key
  #       tests:
  #         - not_null
  #     - name: total_transactions
  #       tests:
  #         - dbt_utils.accepted_range:
  #             min_value: 0
  #             max_value: 10000
  #     - name: fraud_rate_pct
  #       tests:
  #         - dbt_utils.accepted_range:
  #             min_value: 0
  #             max_value: 100
  #             inclusive: true

  # # ===================================================================
  # # GOLD LAYER TESTS - ANALYTICS
  # # ===================================================================

  # - name: predictive_analytics
  #   description: "ML feature set for predictive modeling"
  #   columns:
  #     - name: customer_key
  #       tests:
  #         - unique
  #         - not_null
  #     - name: credit_score
  #       tests:
  #         - dbt_utils.accepted_range:
  #             min_value: 300
  #             max_value: 850
  #     - name: churn_risk_score
  #       tests:
  #         - dbt_utils.accepted_range:
  #             min_value: 0
  #             max_value: 1
  #             inclusive: true
  #     - name: churned_flag
  #       tests:
  #         - accepted_values:
  #             values: [0, 1]
  # - name: account_events
  #   description: "Account lifecycle events and status changes for audit trail"
  #   identifier: account_events
  #   loaded_at_field: event_date
  #   freshness:
  #     warn_after: { count: 6, period: hour }
  #     error_after: { count: 24, period: hour }
  #   columns:
  #     - name: event_id
  #       description: "Primary key - Unique event identifier"
  #       tests:
  #         - unique
  #         - not_null
  #     - name: account_id
  #       description: "Foreign key to accounts"
  #       tests:
  #         - not_null
  #         - relationships:
  #             to: source('ingestion_raw_data', 'accounts')
  #             field: account_id
  #     - name: customer_id
  #       description: "Foreign key to customers"
  #       tests:
  #         - not_null
  #         - relationships:
  #             to: source('ingestion_raw_data', 'customers')
  #             field: customer_id
  #     - name: product_id
  #       description: "Foreign key to products"
  #       tests:
  #         - relationships:
  #             to: source('ingestion_raw_data', 'products')
  #             field: product_id
  #     - name: event_date
  #       description: "Date and time of event"
  #       tests:
  #         - not_null
  #     - name: event_type
  #       description: "Type of account event (e.g., Account Opened, Credit Limit Increased)"
  #       tests:
  #         - not_null
  #     - name: event_category
  #       description: "Event category grouping"
  #       tests:
  #         - accepted_values:
  #             values:
  #               - "Account Setup"
  #               - "Account Closure"
  #               - "Terms Change"
  #               - "Product Change"
  #               - "Fee Related"
  #               - "Payment Issue"
  #               - "Activity Status"
  #               - "Account Modification"
  #     - name: old_value
  #       description: "Previous value (for change events)"
  #     - name: new_value
  #       description: "New value (for change events)"
  #     - name: triggered_by
  #       description: "What triggered the event"
  #       tests:
  #         - accepted_values:
  #             values:
  #               - "Customer Request"
  #               - "System Automated"
  #               - "Bank Policy"
  #               - "Regulatory Requirement"
  #               - "Risk Management"
  #               - "Promotional Offer"
  #     - name: channel
  #       description: "Channel through which event was initiated"
  #       tests:
  #         - accepted_values:
  #             values: ["Online", "Mobile", "Branch", "Phone", "Mail", "System"]
  #     - name: processed_by
  #       description: "Employee ID who processed the event"
  #     - name: notes
  #       description: "Event notes and details"
  #     - name: is_reversible
  #       description: "Flag indicating if event can be reversed"
  #     - name: requires_approval
  #       description: "Flag indicating if event requires approval"
  #     - name: approval_status
  #       description: "Approval status (if applicable)"
  #       tests:
  #         - accepted_values:
  #             values: ["Approved", "Pending", "Rejected"]
  #             where: "approval_status IS NOT NULL"
  #     - name: created_at
  #       description: "Record creation timestamp"

  # - name: regulatory_reports
  #   description: "Regulatory reports and compliance filings"
  #   identifier: regulatory_reports
  #   loaded_at_field: filing_date
  #   freshness:
  #     warn_after: { count: 24, period: hour }
  #     error_after: { count: 72, period: hour }
  #   columns:
  #     - name: report_id
  #       description: "Primary key - Unique report identifier"
  #       tests:
  #         - unique
  #         - not_null
  #     - name: report_type_code
  #       description: "Report type code (e.g., SAR, CTR, HMDA)"
  #       tests:
  #         - not_null
  #         - accepted_values:
  #             values:
  #               - "SAR"
  #               - "CTR"
  #               - "CIP"
  #               - "OFAC"
  #               - "BSA"
  #               - "HMDA"
  #               - "CRA"
  #               - "FFIEC"
  #               - "FDIC"
  #               - "FR-Y9C"
  #               - "AML"
  #               - "KYC"
  #     - name: report_type_name
  #       description: "Full report type name"
  #       tests:
  #         - not_null
  #     - name: report_period_start
  #       description: "Reporting period start date"
  #       tests:
  #         - not_null
  #     - name: report_period_end
  #       description: "Reporting period end date"
  #       tests:
  #         - not_null
  #     - name: filing_date
  #       description: "Date report was generated"
  #       tests:
  #         - not_null
  #     - name: due_date
  #       description: "Regulatory due date"
  #       tests:
  #         - not_null
  #     - name: actual_filing_date
  #       description: "Actual date filed (null if not yet filed)"
  #     - name: filing_status
  #       description: "Current filing status"
  #       tests:
  #         - not_null
  #         - accepted_values:
  #             values:
  #               - "Filed"
  #               - "Pending"
  #               - "In Review"
  #               - "Late Filed"
  #               - "Amended"
  #               - "Withdrawn"
  #     - name: report_frequency
  #       description: "Required reporting frequency"
  #       tests:
  #         - accepted_values:
  #             values: ["Daily", "Monthly", "Quarterly", "Annual", "As Needed"]
  #     - name: regulator
  #       description: "Regulatory body requiring the report"
  #       tests:
  #         - not_null
  #     - name: customer_id
  #       description: "Related customer (if applicable)"
  #       tests:
  #         - relationships:
  #             to: source('ingestion_raw_data', 'customers')
  #             field: customer_id
  #             where: "customer_id IS NOT NULL"
  #     - name: account_id
  #       description: "Related account (if applicable)"
  #       tests:
  #         - relationships:
  #             to: source('ingestion_raw_data', 'accounts')
  #             field: account_id
  #             where: "account_id IS NOT NULL"
  #     - name: transaction_id
  #       description: "Related transaction (if applicable)"
  #       tests:
  #         - relationships:
  #             to: source('ingestion_raw_data', 'transactions')
  #             field: transaction_id
  #             where: "transaction_id IS NOT NULL"
  #     - name: amount_reported
  #       description: "Amount reported (if applicable)"
  #     - name: risk_level
  #       description: "Risk level of the report"
  #       tests:
  #         - accepted_values:
  #             values: ["Low", "Medium", "High", "Critical"]
  #     - name: requires_follow_up
  #       description: "Flag indicating follow-up required"
  #     - name: follow_up_date
  #       description: "Scheduled follow-up date"
  #     - name: assigned_to
  #       description: "Compliance officer assigned"
  #     - name: reviewed_by
  #       description: "Reviewer employee ID"
  #     - name: approval_date
  #       description: "Approval date"
  #     - name: filing_method
  #       description: "Method of filing"
  #       tests:
  #         - accepted_values:
  #             values: ["Electronic", "Paper"]
  #     - name: confirmation_number
  #       description: "Regulatory confirmation number"
  #     - name: findings
  #       description: "Report findings summary"
  #     - name: internal_notes
  #       description: "Internal compliance notes"
  #     - name: is_amended
  #       description: "Flag indicating amended report"
  #     - name: original_report_id
  #       description: "Original report ID (for amendments)"
  #       tests:
  #         - relationships:
  #             to: source('ingestion_raw_data', 'regulatory_reports')
  #             field: report_id
  #             where: "original_report_id IS NOT NULL"
  #     - name: penalty_amount
  #       description: "Penalty amount (if late filed)"
  #     - name: created_at
  #       description: "Record creation timestamp"

  # - name: customer_segments_history
  #   description: "Customer segment change history (SCD Type 2) for tracking customer lifecycle"
  #   identifier: customer_segments_history
  #   loaded_at_field: effective_date
  #   freshness:
  #     warn_after: { count: 24, period: hour }
  #     error_after: { count: 72, period: hour }
  #   columns:
  #     - name: segment_history_id
  #       description: "Primary key - Unique segment history record"
  #       tests:
  #         - unique
  #         - not_null
  #     - name: customer_id
  #       description: "Foreign key to customers"
  #       tests:
  #         - not_null
  #         - relationships:
  #             to: source('ingestion_raw_data', 'customers')
  #             field: customer_id
  #     - name: effective_date
  #       description: "Date segment became effective"
  #       tests:
  #         - not_null
  #     - name: end_date
  #       description: "Date segment ended (null for current segment)"
  #     - name: is_current
  #       description: "Flag indicating current active segment"
  #       tests:
  #         - not_null
  #     - name: customer_segment
  #       description: "Customer segment classification"
  #       tests:
  #         - not_null
  #         - accepted_values:
  #             values: ["Mass Market", "Affluent", "Premium", "Business"]
  #     - name: previous_segment
  #       description: "Previous customer segment"
  #       tests:
  #         - accepted_values:
  #             values: ["Mass Market", "Affluent", "Premium", "Business"]
  #             where: "previous_segment IS NOT NULL"
  #     - name: loyalty_tier
  #       description: "Loyalty program tier"
  #       tests:
  #         - not_null
  #         - accepted_values:
  #             values: ["Bronze", "Silver", "Gold", "Platinum"]
  #     - name: previous_tier
  #       description: "Previous loyalty tier"
  #       tests:
  #         - accepted_values:
  #             values: ["Bronze", "Silver", "Gold", "Platinum"]
  #             where: "previous_tier IS NOT NULL"
  #     - name: risk_segment
  #       description: "Risk classification"
  #       tests:
  #         - not_null
  #         - accepted_values:
  #             values: ["Low", "Medium", "High"]
  #     - name: previous_risk
  #       description: "Previous risk classification"
  #       tests:
  #         - accepted_values:
  #             values: ["Low", "Medium", "High"]
  #             where: "previous_risk IS NOT NULL"
  #     - name: change_type
  #       description: "Type of change that occurred"
  #       tests:
  #         - accepted_values:
  #             values:
  #               - "Segment Change"
  #               - "Tier Change"
  #               - "Risk Change"
  #               - "Multiple Changes"
  #     - name: change_reason
  #       description: "Reason for segment change"
  #     - name: triggered_by
  #       description: "What triggered the segment change"
  #       tests:
  #         - accepted_values:
  #             values:
  #               - "Automated Rule"
  #               - "Manual Review"
  #               - "Relationship Manager"
  #               - "Risk Assessment"
  #               - "Behavioral Model"
  #               - "Campaign Response"
  #     - name: total_accounts
  #       description: "Number of accounts at time of change"
  #     - name: total_balance
  #       description: "Total balance at time of change"
  #     - name: avg_monthly_transactions
  #       description: "Average monthly transaction count"
  #     - name: products_held
  #       description: "Number of products held"
  #     - name: customer_lifetime_value
  #       description: "Estimated CLV at time of change"
  #     - name: tenure_days
  #       description: "Customer tenure in days"
  #     - name: credit_score
  #       description: "Credit score at time of change"
  #     - name: annual_income
  #       description: "Annual income at time of change"
  #     - name: last_interaction_days
  #       description: "Days since last interaction"
  #     - name: digital_engagement_score
  #       description: "Digital engagement score (0-1)"
  #     - name: branch_visits_last_90d
  #       description: "Branch visits in last 90 days"
  #     - name: online_logins_last_90d
  #       description: "Online logins in last 90 days"
  #     - name: eligible_for_premium
  #       description: "Eligible for premium services"
  #     - name: churn_risk
  #       description: "Churn risk level"
  #       tests:
  #         - accepted_values:
  #             values: ["Low", "Medium", "High"]
  #     - name: cross_sell_opportunity
  #       description: "Cross-sell opportunity flag"
  #     - name: notes
  #       description: "Segment change notes"
  #     - name: updated_by
  #       description: "System or user who updated the segment"
  #     - name: created_at
  #       description: "Record creation timestamp"
